name: Build and Release

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build:
    runs-on: windows-latest
    env:
      # Expose the optional personal token as a job env so we can safely reference it
      STARMAP_NUGET_TOKEN: ${{ secrets.STARMAP_NUGET_TOKEN }}

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null
      shell: bash

    - name: Clone KSA DLLs
      run: |
        git clone git@github.com:MarcusZuber/KSA_dlls.git KSA_dlls
      shell: bash

    - name: Add StarMap GitHub Packages NuGet feed (using personal token)
      if: ${{ env.STARMAP_NUGET_TOKEN != '' }}
      run: |
        try { dotnet nuget remove source StarMap } catch { }
        # Use the job environment variable in PowerShell
        dotnet nuget add source "https://nuget.pkg.github.com/StarMapLoader/index.json" --name "StarMap" --username "${{ github.actor }}" --password "$env:STARMAP_NUGET_TOKEN" --store-password-in-clear-text
      shell: powershell

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Create Release Package
      run: |
        $project = 'KittenRemoteControl'
        Write-Host "Searching repository recursively for $project.dll and $project.deps.json (excluding obj folders)..."

        # Find the newest DLL (exclude obj folders)
        $dll = Get-ChildItem -Path . -Filter "$project.dll" -File -Recurse -ErrorAction SilentlyContinue |
               Where-Object { $_.FullName -notmatch '\\obj\\' } |
               Sort-Object LastWriteTime -Descending | Select-Object -First 1

        if (-not $dll) {
          Write-Error "Could not find $project.dll anywhere in the repository. Ensure the project was built successfully."
          exit 1
        }

        # Find the matching deps.json (newest)
        $deps = Get-ChildItem -Path . -Filter "$project.deps.json" -File -Recurse -ErrorAction SilentlyContinue |
                Where-Object { $_.FullName -notmatch '\\obj\\' } |
                Sort-Object LastWriteTime -Descending | Select-Object -First 1

        if (-not $deps) {
          Write-Warning "Could not find $project.deps.json. Continuing without it."
        }

        $packageDir = "$project`_Package"
        $contentDir = "$packageDir/$project"

        # Create directories
        if (Test-Path $contentDir) { Remove-Item -Recurse -Force $contentDir }
        New-Item -ItemType Directory -Path $contentDir -Force | Out-Null

        # Copy files
        Write-Host "Copying DLL: $($dll.FullName) -> $contentDir"
        Copy-Item $dll.FullName -Destination $contentDir -Force

        if ($deps) {
          Write-Host "Copying DEPS: $($deps.FullName) -> $contentDir"
          Copy-Item $deps.FullName -Destination $contentDir -Force
        }

        # Copy additional files (mod.toml, LICENSE) with sensible fallbacks
        $modPaths = @("$project/mod.toml", "./mod.toml", "KittenRemoteControl/mod.toml")
        $copiedMod = $false
        foreach ($p in $modPaths) {
          if (Test-Path $p) { Copy-Item $p $contentDir -Force; $copiedMod = $true; break }
        }
        if (-not $copiedMod) { Write-Warning "mod.toml not found in known locations." }

        if (Test-Path "LICENSE") { Copy-Item "LICENSE" $contentDir -Force } else { Write-Warning "LICENSE not found." }

        # Create zip
        if (Test-Path "$packageDir.zip") { Remove-Item "$packageDir.zip" -Force }
        Compress-Archive -Path $contentDir -DestinationPath "$packageDir.zip" -Force
        Write-Host "Created $packageDir.zip containing:"
        Get-ChildItem -Path $contentDir | ForEach-Object { Write-Host " - $($_.Name)" }
      shell: powershell

    - name: Clean up SSH key
      if: always()
      run: |
        rm -f ~/.ssh/id_rsa
      shell: bash

    - name: Remove cloned DLLs
      if: always()
      run: |
        Remove-Item -Recurse -Force KSA_dlls -ErrorAction SilentlyContinue
      shell: powershell

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: KittenRemoteControl
        path: KittenRemoteControl.zip

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: KittenRemoteControl.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
