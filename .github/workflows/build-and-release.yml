name: Build and Release

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null
      shell: bash

    - name: Clone KSA DLLs
      run: |
        git clone git@github.com:MarcusZuber/KSA_dlls.git KSA_dlls
      shell: bash

    # Register the private GitHub Packages NuGet feed so `dotnet restore` can access it.
    - name: Add StarMap GitHub Packages NuGet feed (using GITHUB_TOKEN)
      run: |
        # If a source with the same name exists, try to remove it first (ignore errors)
        try { dotnet nuget remove source StarMap } catch { }
        dotnet nuget add source "https://nuget.pkg.github.com/StarMapLoader/index.json" --name "StarMap" --username "${{ github.actor }}" --password "${{ secrets.GITHUB_TOKEN }}" --store-password-in-clear-text
      shell: powershell

    # If your feed is in a different account/org or GITHUB_TOKEN doesn't have access,
    # create a personal access token (scope: "read:packages") and add it as the secret
    # STARMAP_NUGET_TOKEN in your repo settings. The step below will run only when that
    # secret is defined and non-empty.
    - name: Add StarMap GitHub Packages NuGet feed (using personal token)
      if: ${{ secrets.STARMAP_NUGET_TOKEN != '' }}
      run: |
        try { dotnet nuget remove source StarMap } catch { }
        dotnet nuget add source "https://nuget.pkg.github.com/StarMapLoader/index.json" --name "StarMap" --username "${{ github.actor }}" --password "${{ secrets.STARMAP_NUGET_TOKEN }}" --store-password-in-clear-text
      shell: powershell

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Create Release Package
      run: |
        $buildDir = "KittenRemoteControl/bin/Release"
        $packageDir = "KittenRemoteControl_Package"
        $contentDir = "$packageDir/KittenRemoteControl"
        
        # Create directories
        New-Item -ItemType Directory -Path $contentDir -Force | Out-Null
        
        # Copy files
        Copy-Item "$buildDir/KittenRemoteControl.dll" $contentDir -Force
        Copy-Item "$buildDir/KittenRemoteControl.deps.json" $contentDir -Force
        Copy-Item "KittenRemoteControl/mod.toml" $contentDir -Force
        Copy-Item "LICENSE" $contentDir -Force
        
        # Create zip
        Compress-Archive -Path $contentDir -DestinationPath "KittenRemoteControl.zip" -Force
      shell: powershell

    - name: Clean up SSH key
      if: always()
      run: |
        rm -f ~/.ssh/id_rsa
      shell: bash

    - name: Remove cloned DLLs
      if: always()
      run: |
        Remove-Item -Recurse -Force KSA_dlls -ErrorAction SilentlyContinue
      shell: powershell

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: KittenRemoteControl
        path: KittenRemoteControl.zip

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: KittenRemoteControl.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
