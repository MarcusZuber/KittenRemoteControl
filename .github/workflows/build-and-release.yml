name: Build and Release

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build:
    runs-on: windows-latest
    env:
      # Expose the optional personal token as a job env so we can safely reference it
      STARMAP_NUGET_TOKEN: ${{ secrets.STARMAP_NUGET_TOKEN }}
      # Optional token to access a private external repo with the KSA DLLs
      KSA_DLLS_TOKEN: ${{ secrets.KSA_DLLS_TOKEN }}

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Checkout KSA_dlls (using personal token)
      if: ${{ env.KSA_DLLS_TOKEN != '' }}
      uses: actions/checkout@v4
      with:
        repository: 'MarcusZuber/KSA_dlls'
        path: 'KSA_dlls'
        token: ${{ env.KSA_DLLS_TOKEN }}

    - name: Checkout KSA_dlls (using runner token)
      if: ${{ env.KSA_DLLS_TOKEN == '' }}
      uses: actions/checkout@v4
      with:
        repository: 'MarcusZuber/KSA_dlls'
        path: 'KSA_dlls'
        token: ${{ github.token }}

    - name: Verify KSA DLLs
      run: |
        Get-ChildItem -Path KSA_dlls -File | Select-Object Name,Length
      shell: powershell

    - name: Fail if KSA DLLs missing
      run: |
        $count = (Get-ChildItem -Path KSA_dlls -Filter '*.dll' -File -ErrorAction SilentlyContinue | Measure-Object).Count
        if ($count -eq 0) {
          Write-Error "No DLLs found in KSA_dlls. Ensure the external repo was checked out and the secret KSA_DLLS_TOKEN is set if the repo is private."
          exit 1
        } else {
          Write-Host "Found $count DLL(s) in KSA_dlls."
        }
      shell: powershell

    # If checkout fails because the external repo is private, add a repository-scoped PAT with
    # at least `repo` / `read:packages` access and store it as the repository secret `KSA_DLLS_TOKEN`.
    # Then rerun the workflow. The `Verify KSA DLLs` step will show the files in the job logs.

    - name: Add StarMap GitHub Packages NuGet feed (using personal token)
      if: ${{ env.STARMAP_NUGET_TOKEN != '' }}
      run: |
        try { dotnet nuget remove source StarMap } catch { }
        # Use the job environment variable in PowerShell
        dotnet nuget add source "https://nuget.pkg.github.com/StarMapLoader/index.json" --name "StarMap" --username "${{ github.actor }}" --password "$env:STARMAP_NUGET_TOKEN" --store-password-in-clear-text
      shell: powershell

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Create Release Package
      run: |
        $buildDir = "KittenRemoteControl/bin/Release"
        $packageDir = "KittenRemoteControl_Package"
        $contentDir = "$packageDir/KittenRemoteControl"
        
        # Create directories
        New-Item -ItemType Directory -Path $contentDir -Force | Out-Null
        
        # Copy files
        Copy-Item "$buildDir/KittenRemoteControl.dll" $contentDir -Force
        Copy-Item "$buildDir/KittenRemoteControl.deps.json" $contentDir -Force
        Copy-Item "KittenRemoteControl/mod.toml" $contentDir -Force
        Copy-Item "LICENSE" $contentDir -Force
        
        # Create zip
        Compress-Archive -Path $contentDir -DestinationPath "KittenRemoteControl.zip" -Force
      shell: powershell

    - name: Remove cloned DLLs
      if: always()
      run: |
        Remove-Item -Recurse -Force KSA_dlls -ErrorAction SilentlyContinue
      shell: powershell

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: KittenRemoteControl
        path: KittenRemoteControl.zip

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: KittenRemoteControl.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
